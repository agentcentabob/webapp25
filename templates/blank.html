{% extends 'layout.html' %} {% block content %}
<head>
    <link rel="stylesheet" href="static/css/notes.css"/>
    <title>Note editor - URBANNOTES</title>
    <!-- Marked.js for markdown parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
</head>

<body>
    <div class="note-editor-container">
        <div class="editor-header">
            <input type="text" 
                class="note-title-input" 
                id="noteTitle" 
                placeholder="Untitled Note"
                value="">
            <div class="editor-actions">
                <button class="action-btn toggle" onclick="togglePreview()" id="toggleBtn">
                    üëÅÔ∏è Toggle Preview
                </button>
                <button class="action-btn save" onclick="saveNote()">üíæ Save</button>
                <button class="action-btn delete" onclick="deleteNote()">üóëÔ∏è Delete</button>
            </div>
        </div>

        <div class="editor-body" id="editorBody">
            <div class="editor-pane">
                <div class="pane-header">Editor</div>
                <div class="pane-content">
                    <textarea class="note-editor" 
                              id="noteContent" 
                              placeholder="Start typing your note... Markdown is supported!

# Example Markdown
## Heading 2
**Bold text** and *italic text*
- Bullet point
- Another point

1. Numbered list
2. Another item

[Link text](https://example.com)
`code` and ```code blocks```"></textarea>
                </div>
            </div>

            <div class="editor-pane" id="previewPane">
                <div class="pane-header">Preview</div>
                <div class="pane-content">
                    <div class="markdown-preview" id="markdownPreview">
                        <p style="color: #95a5a6;">Preview will appear here...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-footer">
            <div class="markdown-hint">
                üìù Markdown supported | Split view active
            </div>
            <div class="last-saved" id="lastSaved">
                Not saved yet
            </div>
        </div>
    </div>

    <script>
        let currentNoteId = null;
        let autoSaveTimeout;
        let previewVisible = true;

        // Configure marked options
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        // Load a note into the editor (call this from your main app)
        function loadNote(noteId, title, content) {
            currentNoteId = noteId;
            document.getElementById('noteTitle').value = title || '';
            document.getElementById('noteContent').value = content || '';
            updatePreview();
            updateLastSaved('Loaded');
        }

        // Get current note data
        function getCurrentNoteData() {
            return {
                id: currentNoteId,
                title: document.getElementById('noteTitle').value,
                content: document.getElementById('noteContent').value
            };
        }

        // Update markdown preview
        function updatePreview() {
            const content = document.getElementById('noteContent').value;
            const preview = document.getElementById('markdownPreview');
            
            if (content.trim() === '') {
                preview.innerHTML = '<p style="color: #95a5a6;">Preview will appear here...</p>';
            } else {
                preview.innerHTML = marked.parse(content);
            }
        }

        // Toggle preview pane
        function togglePreview() {
            previewVisible = !previewVisible;
            const previewPane = document.getElementById('previewPane');
            const editorBody = document.getElementById('editorBody');
            
            if (previewVisible) {
                previewPane.classList.remove('hidden');
                editorBody.classList.remove('editor-only');
            } else {
                previewPane.classList.add('hidden');
                editorBody.classList.add('editor-only');
            }
        }

        // Save the current note
        function saveNote() {
            if (!currentNoteId) {
                // FLASH MESSAGE: "No note loaded"
                alert('No note loaded');
                return;
            }

            const noteData = getCurrentNoteData();
            
            // TODO: Replace with your API call
            // Example:
            // fetch('/api/notes/' + currentNoteId, {
            //     method: 'PUT',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify(noteData)
            // })
            // .then(response => response.json())
            // .then(data => {
            //     // FLASH MESSAGE: "Note saved successfully"
            //     updateLastSaved('Just now');
            // })
            // .catch(error => {
            //     // FLASH MESSAGE: "Error saving note"
            //     console.error('Error:', error);
            // });

            // Temporary demo
            console.log('Saving note:', noteData);
            updateLastSaved('Just now');
            flash("Note saved successfully!", "success");
        }

        // Delete the current note
        function deleteNote() {
            if (!currentNoteId) {
                // FLASH MESSAGE: "No note loaded"
                alert('No note loaded');
                return;
            }

            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            // TODO: Replace with your API call
            // Example:
            // fetch('/api/notes/' + currentNoteId, {
            //     method: 'DELETE'
            // })
            // .then(response => {
            //     if (response.ok) {
            //         // FLASH MESSAGE: "Note deleted successfully"
            //         // Redirect or clear the editor
            //         clearEditor();
            //     }
            // })
            // .catch(error => {
            //     // FLASH MESSAGE: "Error deleting note"
            //     console.error('Error:', error);
            // });

            // Temporary demo
            console.log('Deleting note:', currentNoteId);
            // FLASH MESSAGE: "Note deleted successfully"
            alert('Note deleted! (Replace this with your flash message and redirect)');
            clearEditor();
        }

        // Clear the editor
        function clearEditor() {
            currentNoteId = null;
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            updatePreview();
            updateLastSaved('Not saved yet');
        }

        // Update last saved timestamp
        function updateLastSaved(text) {
            document.getElementById('lastSaved').textContent = text;
        }

        // Auto-save functionality (optional - saves 2 seconds after stopping typing)
        function setupAutoSave() {
            const titleInput = document.getElementById('noteTitle');
            const contentInput = document.getElementById('noteContent');

            titleInput.addEventListener('input', () => {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    if (currentNoteId) {
                        saveNote();
                    }
                }, 2000);
            });

            contentInput.addEventListener('input', () => {
                updatePreview();
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(() => {
                    if (currentNoteId) {
                        saveNote();
                    }
                }, 2000);
            });
        }

        // Initialize
        setupAutoSave();

        // Example usage - you would call this from your main app:
        // loadNote(123, 'My Note Title', '# My Note Content\nSome text here');
    </script>
</body>
</html>
{% endblock %}